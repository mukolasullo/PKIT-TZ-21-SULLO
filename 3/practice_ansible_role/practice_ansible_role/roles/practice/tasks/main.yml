---
- name: Ensure apt packages are installed
  apt:
    name: "{{ packages }}"
    state: present
    update_cache: yes
    cache_valid_time: "{{ apt_cache_valid_time }}"
  become: true

- name: Create application directory
  file:
    path: "{{ app_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true

- name: Ensure static directory exists
  file:
    path: "{{ app_dir }}/static"
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true

- name: Copy Flask application file (with rename)
  copy:
    src: app.py
    dest: "{{ app_dir }}/{{ app_file }}"
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: daemon-reload

- name: Copy static files
  copy:
    src: static/cat.gif
    dest: "{{ app_dir }}/static/cat.gif"
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: daemon-reload

- name: Copy requirements.txt to app dir
  copy:
    src: requirements.txt
    dest: "{{ app_dir }}/requirements.txt"
    owner: root
    group: root
    mode: "0644"
  become: true

- name: Create python virtualenv for the app
  command: /usr/bin/python3 -m venv {{ app_dir }}/venv
  args:
    creates: "{{ app_dir }}/venv"
  become: true

- name: Install Python dependencies into virtualenv
  pip:
    requirements: "{{ app_dir }}/requirements.txt"
    virtualenv: "{{ app_dir }}/venv"
    virtualenv_command: /usr/bin/python3 -m venv
  become: true

- name: Install systemd unit file for Flask app
  template:
    src: flask_app.service.j2
    dest: "/etc/systemd/system/{{ app_file | regex_replace('\\..*$', '') }}.service"
    owner: root
    group: root
    mode: "0644"
  become: true
  notify:
    - daemon-reload
    - restart-flask

- name: Install nginx site configuration
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/sites-available/default
    owner: root
    group: root
    mode: "0644"
  become: true
  notify:
    - restart-nginx

- name: Ensure service is enabled and started
  systemd:
    name: "{{ app_file | regex_replace('\\..*$', '') }}"
    state: started
    enabled: true
  become: true
